<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js" integrity="sha384-7EyYLQZgWBi67fBtVxw60/OWl1kjsfrPFcaU0pp0nAh+i8FD068QogUvg85Ewy1k" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous" />
    <title>socket-chat</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      .chat-list::-webkit-scrollbar {
        width: 5px;
      }
      /* .chat-list::-webkit-scrollbar-track {
        border-radius: 4px;
        background-color: gray;
      } */
      .chat-list::-webkit-scrollbar-thumb {
        border-radius: 4px;
        background-color: #ffc600;
      }
      .chat-list {
        background-color: skyblue;
        width: 300px;
        height: 400px;
        overflow-y: scroll;
        margin: 10px 10px;
      }
      .my-chat {
        /* display: flex; */
        text-align: right;
        /* flex-direction: row-reverse; */
      }
      .my-chat > div {
        display: inline-block;
        background-color: #ffeb33;
        margin: 5px 5px;
        border-radius: 5px;
      }
      .other-chat {
        text-align: left;
      }
      .other-chat > div {
        display: inline-block;
        background-color: white;
        margin: 5px 5px;
        border-radius: 5px;
      }
      .nickname,
      .out {
        color: gray;
        font-size: 0.8rem;
        margin: 6px 10px;
        text-align: center;
      }
      .enter {
        background-color: transparent;
        border: none;
        font-size: 0.9rem;
      }
      .enter :hover {
        cursor: auto;
      }
      #msg {
        height: 100%;
        overflow-y: auto;
        width: 86%;
      }
      #button {
        width: 12%;
        border: none;
        background-color: #ffeb33;
        font-size: 0.9rem;
      }
      .topinput {
        margin: 10px 10px;
      }
      .textinput {
        margin: 0 10px;
        display: flex;
        width: 300px;
        height: 50px;
        justify-content: space-between;
      }
    </style>
  </head>
  <body>
    <div class="topinput">
      <input type="text" name="name" class="nickname" placeholder="ID를 입력해주세요" onfocus="clearF(this)" /> (으)로
      <button type="button" onclick="enteR()" class="enter">입장하기</button>
    </div>
    <div class="chat-list">
      <!-- <div class="my-chat"><div>안녕</div></div>
        <div class="other-chat"><div>하이</div></div> -->
      <!-- <div class="enter">~~~입장하셨습니다</div> -->
      <!-- <div class="out">~~~퇴장했습니다</div> -->
    </div>
    <div class="textinput">
      <input type="text" name="msg" id="msg" />
      <button type="button" onclick="sendMsg();" id="button">전송</button>
    </div>

    <script>
      var socket = io.connect();

      var nickname;

      function enteR() {
        nickname = $(".nickname").val();
        if (nickname == "") {
          alert("ID를 입력해주세요");
        } else {
          socket.emit("enter", nickname);
          $(".topinput").addClass("d-none");
          $("#msg").focus();
        }
      }
      function clearF(target) {
        if (target.value == "ID를 입력해주세요") {
          target.value = "";
        }
      }
      document.querySelector(".nickname").addEventListener("keydown", ({ key }) => {
        if (key == "Enter") {
          enteR();
        }
      });

      socket.on("enter", (nickname) => {
        $(".chat-list").append(`<div class="nickname">${nickname}님이 입장했습니다</div>`);
      });

      function sendMsg() {
        var msg = $("#msg").val();
        var data = {
          name: nickname,
          msg: msg,
        };
        if (nickname == undefined) {
          alert("입장 후 전송을 눌러주세요.");
        } else if (msg == "") {
          alert("메세지를 입력해주세요.");
        } else {
          socket.emit("sendMsg", data);
        }
        // console.log(msg);

        $("#msg").val("");
        // $(".chat-list").scrollTop($(".chat-list").prop('scrollHeight')-34);
        $(".chat-list").scrollTop($(document).height() + 1000);
        // console.log($(".chat-list").scrollTop($(document).height()));
      }

      document.querySelector("#msg").addEventListener("keydown", ({ key }) => {
        if (key == "Enter") {
          sendMsg();
        }
      });

      socket.on("send", (data) => {
        var className = "";
        if (data.name == nickname) {
          className = "my-chat";
          $(".chat-list").append(`<div class=${className}><div>${data.msg}</div></div>`);
        } else {
          className = "other-chat";
          $(".chat-list").append(`<div class=${className}><div>${data.name}` + ` : ` + `${data.msg}</div></div>`);
        }
      });

      var outname = $(".nickname").val();
      socket.on("out", (data) => {
        $(".chat-list").append(`<div class="out">${data}님이 퇴장했습니다</div>`);
      });
    </script>
  </body>
</html>
